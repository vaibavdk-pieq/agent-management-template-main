name: "agent-management"

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, reopened, synchronize]
    branches: [ main ]
env:
  # AWS Configuration
  AWS_REGION: "us-east-1"
  AWS_ROLE_ARN: "arn:aws:iam::910020091862:role/git-access-role"

  # CodeArtifact Configuration (now centralized in gradle.properties)
  # All CodeArtifact settings are managed through gradle.properties and setup script

permissions:
  actions: read
  contents: read
  pull-requests: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get CodeArtifact token
        id: codeartifact-auth
        run: |
          echo "ğŸ” Getting CodeArtifact authorization token..."
          
          # CodeArtifact configuration (from gradle.properties)
          CODEARTIFACT_DOMAIN=pieq
          CODEARTIFACT_DOMAIN_OWNER=910020091862
          CODEARTIFACT_REGION=us-east-1
          CODEARTIFACT_REPOSITORY=pieq-artifact
          
          echo "ğŸ“‹ Using CodeArtifact configuration:"
          echo "   Domain: $CODEARTIFACT_DOMAIN"
          echo "   Domain Owner: $CODEARTIFACT_DOMAIN_OWNER"
          echo "   Region: $CODEARTIFACT_REGION"
          echo "   Repository: $CODEARTIFACT_REPOSITORY"
          
          export CODEARTIFACT_AUTH_TOKEN=$(aws codeartifact get-authorization-token \
            --domain "$CODEARTIFACT_DOMAIN" \
            --domain-owner "$CODEARTIFACT_DOMAIN_OWNER" \
            --query authorizationToken \
            --output text)

          echo "âœ… CodeArtifact token retrieved successfully!"
          echo "   Token preview: ${CODEARTIFACT_AUTH_TOKEN:0:20}..."

          echo "CODEARTIFACT_AUTH_TOKEN=$CODEARTIFACT_AUTH_TOKEN" >> $GITHUB_ENV
          
          echo "ğŸ”— Getting CodeArtifact repository endpoint..."
          export CODEARTIFACT_REPO_URL=$(aws codeartifact get-repository-endpoint \
            --domain "$CODEARTIFACT_DOMAIN" \
            --domain-owner "$CODEARTIFACT_DOMAIN_OWNER" \
            --repository "$CODEARTIFACT_REPOSITORY" \
            --format maven \
            --query repositoryEndpoint \
            --output text)

          echo "âœ… CodeArtifact repository endpoint retrieved!"
          echo "   Repository URL: $CODEARTIFACT_REPO_URL"
          echo "CODEARTIFACT_REPO_URL=$CODEARTIFACT_REPO_URL" >> $GITHUB_ENV

      - name: Verify CodeArtifact configuration
        run: |
          echo "ğŸ” Verifying CodeArtifact configuration..."
          
          # CodeArtifact configuration (from gradle.properties)
          CODEARTIFACT_DOMAIN=pieq
          CODEARTIFACT_DOMAIN_OWNER=910020091862
          CODEARTIFACT_REGION=us-east-1
          CODEARTIFACT_REPOSITORY=pieq-artifact
          
          # Test connectivity by listing packages
          echo "ğŸ“¦ Testing repository connectivity..."
          aws codeartifact list-packages \
            --domain "$CODEARTIFACT_DOMAIN" \
            --domain-owner "$CODEARTIFACT_DOMAIN_OWNER" \
            --repository "$CODEARTIFACT_REPOSITORY" \
            --max-items 3 \
            --query 'packages[0:3].{Package:package,Namespace:namespace,Format:format}' \
            --output table || echo "âš ï¸  Could not list packages (this might be normal for empty repositories)"
          
          echo "âœ… CodeArtifact configuration verified!"
          echo "   Environment variables set:"
          echo "   - CODEARTIFACT_AUTH_TOKEN: ${#CODEARTIFACT_AUTH_TOKEN} characters"
          echo "   - CODEARTIFACT_REPO_URL: $CODEARTIFACT_REPO_URL"
          echo "   - Configuration source: Direct from workflow (gradle.properties values)"

      - name: Build and test project
        run: |
          echo "ğŸ—ï¸  Starting build with CodeArtifact integration..."
          echo "   Configuration source: Direct from workflow (gradle.properties values)"
          echo "   Using CodeArtifact repository: $CODEARTIFACT_REPO_URL"
          echo "   Token available: ${#CODEARTIFACT_AUTH_TOKEN} characters"
          
          ./gradlew clean assemble test jacocoTestReport --no-daemon
          
          echo "âœ… Build and tests completed successfully!"
          echo "   CodeArtifact integration: Active"
          echo "   Configuration: Direct from workflow"
        env:
          CODEARTIFACT_AUTH_TOKEN: ${{ env.CODEARTIFACT_AUTH_TOKEN }}
          CODEARTIFACT_REPO_URL: ${{ env.CODEARTIFACT_REPO_URL }}

      - name: Run PMD static analysis
        run: |
          echo "ğŸ” Running PMD static analysis..."
          # Create reports directory
          mkdir -p build/reports/pmd
          
          # Download PMD
          wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F6.55.0/pmd-bin-6.55.0.zip
          unzip pmd-bin-6.55.0.zip
          
          # Find all Kotlin source directories
          echo "ğŸ“ Searching for Kotlin source files..."
          find . -name "*.kt" -type f | head -10
          
          # Run PMD on all subprojects with Kotlin source
          echo "ğŸ“ Running PMD analysis on Kotlin files..."
          
          # Run PMD on all subprojects with Kotlin source
          echo "ğŸ“ Running PMD analysis on all Kotlin files..."
          
          # Create a combined report
          touch build/reports/pmd/pmd-report.txt
          touch build/reports/pmd/pmd-report.xml
          
          # Analyze agent-management-application
          if [ -d "agent-management-application/src/main/kotlin" ]; then
            echo "âœ… Analyzing agent-management-application Kotlin sources"
            ./pmd-bin-6.55.0/bin/run.sh pmd \
              -d agent-management-application/src/main/kotlin \
              -R rulesets/java/quickstart.xml \
              -f text \
              --fail-on-violation false >> build/reports/pmd/pmd-report.txt 2>&1 || echo "PMD analysis completed with findings"
            
            ./pmd-bin-6.55.0/bin/run.sh pmd \
              -d agent-management-application/src/main/kotlin \
              -R rulesets/java/quickstart.xml \
              -f xml \
              --fail-on-violation false >> build/reports/pmd/pmd-report.xml 2>&1 || echo "PMD XML report generated"
          fi
          
          # Analyze agent-management-api
          if [ -d "agent-management-api/src/main/kotlin" ]; then
            echo "âœ… Analyzing agent-management-api Kotlin sources"
            ./pmd-bin-6.55.0/bin/run.sh pmd \
              -d agent-management-api/src/main/kotlin \
              -R rulesets/java/quickstart.xml \
              -f text \
              --fail-on-violation false >> build/reports/pmd/pmd-report.txt 2>&1 || echo "PMD analysis completed with findings"
            
            ./pmd-bin-6.55.0/bin/run.sh pmd \
              -d agent-management-api/src/main/kotlin \
              -R rulesets/java/quickstart.xml \
              -f xml \
              --fail-on-violation false >> build/reports/pmd/pmd-report.xml 2>&1 || echo "PMD XML report generated"
          fi
          
          # Analyze agent-management-client
          if [ -d "agent-management-client/src/main/kotlin" ]; then
            echo "âœ… Analyzing agent-management-client Kotlin sources"
            ./pmd-bin-6.55.0/bin/run.sh pmd \
              -d agent-management-client/src/main/kotlin \
              -R rulesets/java/quickstart.xml \
              -f text \
              --fail-on-violation false >> build/reports/pmd/pmd-report.txt 2>&1 || echo "PMD analysis completed with findings"
            
            ./pmd-bin-6.55.0/bin/run.sh pmd \
              -d agent-management-client/src/main/kotlin \
              -R rulesets/java/quickstart.xml \
              -f xml \
              --fail-on-violation false >> build/reports/pmd/pmd-report.xml 2>&1 || echo "PMD XML report generated"
          fi
          
          # Check if any analysis was performed
          if [ ! -s build/reports/pmd/pmd-report.txt ]; then
            echo "âš ï¸  No Kotlin sources found in any subproject"
            echo "PMD analysis skipped - no source files found" > build/reports/pmd/pmd-report.txt
            echo "PMD analysis skipped - no source files found" > build/reports/pmd/pmd-report.xml
          fi
          
          echo "âœ… PMD analysis completed"

      - name: Run SpotBugs analysis
        run: |
          echo "ğŸ› Running SpotBugs analysis..."
          # Download SpotBugs
          wget https://github.com/spotbugs/spotbugs/releases/download/4.7.3/spotbugs-4.7.3.tgz
          tar -xzf spotbugs-4.7.3.tgz
          
          # Find all Kotlin compiled classes directories
          echo "ğŸ” Searching for Kotlin compiled classes..."
          
          CLASSES_DIRS=""
          
          # Check agent-management-application
          if [ -d "agent-management-application/build/classes/kotlin/main" ]; then
            CLASSES_DIRS="$CLASSES_DIRS agent-management-application/build/classes/kotlin/main"
            echo "âœ… Found agent-management-application classes"
          fi
          
          # Check agent-management-api
          if [ -d "agent-management-api/build/classes/kotlin/main" ]; then
            CLASSES_DIRS="$CLASSES_DIRS agent-management-api/build/classes/kotlin/main"
            echo "âœ… Found agent-management-api classes"
          fi
          
          # Check agent-management-client
          if [ -d "agent-management-client/build/classes/kotlin/main" ]; then
            CLASSES_DIRS="$CLASSES_DIRS agent-management-client/build/classes/kotlin/main"
            echo "âœ… Found agent-management-client classes"
          fi
          
          # Check root build directory
          if [ -d "build/classes/kotlin/main" ]; then
            CLASSES_DIRS="$CLASSES_DIRS build/classes/kotlin/main"
            echo "âœ… Found root build classes"
          fi
          
          if [ -z "$CLASSES_DIRS" ]; then
            echo "âš ï¸  No Kotlin classes found, searching for any compiled classes..."
            find . -name "*.class" -type f | head -5
            echo "âœ… SpotBugs analysis skipped (no compiled classes)"
            exit 0
          fi
          
          echo "ğŸ“ Using classes directories: $CLASSES_DIRS"
          
          # Run SpotBugs analysis on all Kotlin compiled classes
          ./spotbugs-4.7.3/bin/spotbugs \
            -textui \
            -effort:max \
            -low \
            -xml:withMessages \
            -output build/reports/spotbugs.xml \
            $CLASSES_DIRS || echo "SpotBugs analysis completed"
          echo "âœ… SpotBugs analysis completed"

      - name: Run Kotlin-specific static analysis
        run: |
          echo "ğŸ” Running Kotlin-specific static analysis..."
          mkdir -p build/reports/kotlin-analysis
          
          # Check if we're in a multi-project setup
          echo "ğŸ“ Project structure check..."
          ls -la
          echo "ğŸ“ Subprojects:"
          ls -la */src/main/kotlin/ 2>/dev/null || echo "No subproject Kotlin sources found"
          
          # Run ktlint for Kotlin code style checking
          echo "ğŸ“ Running ktlint..."
          ./gradlew ktlintCheck --no-daemon > build/reports/kotlin-analysis/ktlint-report.txt 2>&1 || echo "ktlint completed with findings"
          
          # Run detekt for Kotlin static analysis (if available)
          echo "ğŸ” Running detekt..."
          ./gradlew detekt --no-daemon > build/reports/kotlin-analysis/detekt-report.txt 2>&1 || echo "detekt completed with findings"
          
          # Also run spotless for code formatting check
          echo "ğŸ¨ Running spotless check..."
          ./gradlew spotlessCheck --no-daemon > build/reports/kotlin-analysis/spotless-report.txt 2>&1 || echo "spotless completed with findings"
          
          echo "âœ… Kotlin-specific analysis completed"

      - name: Display comprehensive results
        run: |
          echo "ğŸ‰ All checks completed successfully!"
          echo ""
          echo "ğŸ“Š Summary:"
          echo "  âœ… Build: Completed"
          echo "  âœ… Tests: Completed"
          echo "  âœ… PMD Static Analysis: Completed"
          echo "  âœ… SpotBugs Analysis: Completed"
          echo "  âœ… Kotlin-specific Analysis: Completed"
          echo ""
          echo "ğŸ” CodeArtifact Integration:"
          echo "  âœ… Token retrieved and configured"
          echo "  âœ… Repository endpoint: $CODEARTIFACT_REPO_URL"
          echo "  âœ… Build dependencies resolved from CodeArtifact"
          echo "  âœ… Direct configuration from workflow"
          echo ""
          
          # Show test coverage summary
          if [ -f "build/reports/jacoco/test/jacocoTestReport.xml" ]; then
            echo "ğŸ“ˆ Test Coverage Report:"
            echo "  Location: build/reports/jacoco/test/"
            echo "  HTML: build/reports/jacoco/test/html/index.html"
            
            # Extract coverage metrics from XML
            if command -v xmllint >/dev/null 2>&1; then
              echo "  Coverage Summary:"
              xmllint --xpath "//report/counter[@type='LINE']/@covered" build/reports/jacoco/test/jacocoTestReport.xml 2>/dev/null | sed 's/covered="//;s/"//' | while read covered; do
                xmllint --xpath "//report/counter[@type='LINE']/@missed" build/reports/jacoco/test/jacocoTestReport.xml 2>/dev/null | sed 's/missed="//;s/"//' | while read missed; do
                  total=$((covered + missed))
                  if [ $total -gt 0 ]; then
                    percentage=$((covered * 100 / total))
                    echo "    Line Coverage: $covered/$total lines ($percentage%)"
                  fi
                done
              done
            fi
          fi
          
          # Show static analysis reports
          if [ -f "build/reports/spotbugs.xml" ]; then
            echo "ğŸ› SpotBugs Report:"
            echo "  Location: build/reports/spotbugs.xml"
            
            # Count SpotBugs findings
            if command -v xmllint >/dev/null 2>&1; then
              bug_count=$(xmllint --xpath "count(//BugInstance)" build/reports/spotbugs.xml 2>/dev/null || echo "0")
              echo "  Findings: $bug_count bugs detected"
            fi
          fi
          
          # Show PMD findings
          if [ -f "build/reports/pmd/pmd-report.txt" ]; then
            echo "ğŸ” PMD Report:"
            echo "  Location: build/reports/pmd/pmd-report.txt"
            
            # Count PMD violations
            violation_count=$(grep -c "PMD" build/reports/pmd/pmd-report.txt 2>/dev/null || echo "0")
            echo "  Violations: $violation_count issues found"
          fi
          
          echo ""
          echo "ğŸ” Static analysis results are available in the logs above"
          echo "ğŸ“‹ All reports are generated in the build/reports/ directory"

      - name: Generate coverage summary
        if: always()
        run: |
          echo "ğŸ“Š Generating coverage summary..."
          
          # Create a summary file
          cat > build/reports/coverage-summary.md << EOF
          # Test Coverage Summary
          
          ## JaCoCo Coverage Report
          - **HTML Report**: [View Coverage Report](build/reports/jacoco/test/html/index.html)
          - **XML Report**: build/reports/jacoco/test/jacocoTestReport.xml
          
          ## Static Analysis Reports
          - **PMD Report**: build/reports/pmd/pmd-report.txt
          - **SpotBugs Report**: build/reports/spotbugs.xml
          
          ## Build Information
          - **Build Time**: $(date)
          - **Branch**: ${{ github.ref }}
          - **Commit**: ${{ github.sha }}
          EOF
          
          echo "âœ… Coverage summary generated: build/reports/coverage-summary.md"

      - name: Comment PR with results summary
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let summary = '## ğŸ“Š Build Results Summary\n\n';
            
            // Test coverage summary
            try {
              const jacocoPath = 'build/reports/jacoco/test/jacocoTestReport.xml';
              if (fs.existsSync(jacocoPath)) {
                summary += '### âœ… Test Coverage\n';
                summary += '- JaCoCo reports generated successfully\n';
                summary += '- HTML report available in artifacts\n';
                summary += '- XML report available for CI integration\n\n';
              }
            } catch (e) {
              summary += '### âš ï¸ Test Coverage\n';
              summary += '- Coverage reports not available\n\n';
            }
            
            // Static analysis summary
            summary += '### ğŸ” Static Analysis\n';
            
            try {
              const spotbugsPath = 'build/reports/spotbugs.xml';
              if (fs.existsSync(spotbugsPath)) {
                summary += '- âœ… SpotBugs analysis completed\n';
              }
            } catch (e) {
              summary += '- âŒ SpotBugs analysis failed\n';
            }
            
            try {
              const pmdPath = 'build/reports/pmd/pmd-report.txt';
              if (fs.existsSync(pmdPath)) {
                summary += '- âœ… PMD analysis completed\n';
              }
            } catch (e) {
              summary += '- âŒ PMD analysis failed\n';
            }
            
            summary += '\n### ğŸ“‹ Reports Available\n';
            summary += '- Test Coverage: Download `test-coverage-reports` artifact\n';
            summary += '- Static Analysis: Download `static-analysis-reports` artifact\n';
            summary += '- All Reports: Download `build-reports` artifact\n\n';
            
            summary += '### ğŸ”— Quick Links\n';
            summary += '- [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n';
            summary += '- [Download Artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)\n';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: summary
            });

      - name: Upload test coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "agent-management"
          path: |
            build/reports/jacoco/
            build/reports/tests/
          retention-days: 10

      - name: Upload static analysis reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "agent-management"
          path: |
            build/reports/spotbugs.xml
            build/reports/pmd/
            build/reports/kotlin-analysis/
            build/reports/coverage-summary.md
          retention-days: 10

      - name: Upload build reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "agent-management"
          path: |
            build/reports/
            build/reports/coverage-summary.md
          retention-days: 10

      - name: Cleanup temporary files
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up temporary files..."
          rm -f codeartifact.token
          echo "âœ… Cleanup completed"

  # 2ï¸âƒ£ Manual review reminder only on PRs, after all checks succeed
  manual_review_notice:
    name: "agent-management"
    needs: build
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Post PR comment for manual review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: [
                'ğŸ” **Manual Code Review Required**',
                '',
                `@${pr.user.login} your changes have passed all checks:`,
                'âœ… Build completed successfully',
                'âœ… All tests passed',
                'âœ… Static analysis completed',
                '',
                'Please review the code, inspect any findings, and approve or request changes before merging.'
              ].join('\n')
            });

